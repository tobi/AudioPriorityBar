name: Build and Release

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build
        run: |
          xcodebuild -scheme AudioPriorityBar \
            -configuration Release \
            -derivedDataPath build \
            -arch arm64 -arch x86_64 \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Import Code Signing Certificate
        if: env.CERTIFICATE_BASE64 != ''
        env:
          CERTIFICATE_BASE64: ${{ secrets.DEVELOPER_ID_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.DEVELOPER_ID_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          echo "$CERTIFICATE_BASE64" | base64 --decode > "$CERTIFICATE_PATH"
          security import "$CERTIFICATE_PATH" -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          # Allow codesign to access the keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

      - name: Sign App
        if: env.DEVELOPER_ID_APPLICATION != ''
        env:
          DEVELOPER_ID_APPLICATION: ${{ secrets.DEVELOPER_ID_APPLICATION }}
        run: |
          codesign --force --deep --options runtime \
            --entitlements AudioPriorityBar/AudioPriorityBar.entitlements \
            --sign "$DEVELOPER_ID_APPLICATION" \
            build/Build/Products/Release/AudioPriorityBar.app

          codesign --verify --verbose=2 build/Build/Products/Release/AudioPriorityBar.app

      - name: Create App Bundle
        run: |
          mkdir -p release
          cp -R build/Build/Products/Release/AudioPriorityBar.app release/
          cd release
          ditto -c -k --keepParent AudioPriorityBar.app AudioPriorityBar.zip

      - name: Notarize App
        if: env.APPLE_ID != ''
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          NOTARIZATION_PASSWORD: ${{ secrets.NOTARIZATION_PASSWORD }}
        run: |
          xcrun notarytool submit release/AudioPriorityBar.zip \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$NOTARIZATION_PASSWORD" \
            --wait

          xcrun stapler staple release/AudioPriorityBar.app

          # Re-create zip with stapled app
          cd release
          rm AudioPriorityBar.zip
          ditto -c -k --keepParent AudioPriorityBar.app AudioPriorityBar.zip

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: AudioPriorityBar
          path: release/AudioPriorityBar.zip

      - name: Create Nightly Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: nightly
          name: Nightly Build
          body: |
            Automated nightly build from the latest commit on main.

            **Commit:** ${{ github.sha }}
            **Date:** ${{ github.event.head_commit.timestamp }}
          files: release/AudioPriorityBar.zip
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Tagged Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: release/AudioPriorityBar.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
